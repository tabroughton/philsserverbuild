#+TITLE: Server Build & Container Management
#+AUTHOR: tabroughton
#+OPTIONS: toc:t num:nil

* Overview

This repository / collection of scripts provides a *deliberate, security-first*
approach to building and managing a Docker-based server, with a focus on:

- Game servers
- Long-lived stateful containers
- Predictable networking behavior
- Avoiding accidental public exposure

Everything here is designed to be:

- Explicit
- Reproducible
- Safe to re-run
- Easy to audit

* High-Level Design

The system is built around three core ideas:

1. The *host* debian is protected by a conventional firewall (firewalld)
2. Docker containers are *LAN-only by default*
3. Public exposure is always an explicit, separate action

This avoids the common Docker pitfall where publishing a port immediately makes
a service public.

* Sever preparation

1. Install Debian from USB stick
   - Enter in wifi details
   - Do not enter root pwd, so no root user is available
   - Create non-root user with sudo access
   - Install including mirror so apt and sources are set up, if not
     set this up once logged into the server first time
   - Software selection: deselect debian desktop and Gnome etc.
     Select only ssh and default tools.
2. Log in
3. Install git =sudo apt-get install git=
4. optionally you can set a backup device now 
   - ensure SD card inserted
   - partition if needed and format to ext4
   - use =sudo blkid= to identify device ID (eg /dev/sda1)
   - edit the buildserver.sh and update the BACKUP_DEVICE_UUID
   - (note this can be done afterwards but your backups are not saving
     properly until you do this - see =README-update-backup-device.org=)
5. Clone this repo and run =sudo ./buildserver.sh=
   - =README-server-bootstrap.org=
     
* Components

** Server bootstrap
Sets up the base server environment:

- firewalld (host firewall)
- Docker Engine
- Cockpit (host management)
- Portainer (container management)
- fail2ban and basic SSH hardening

See:
- =README-server-buildserver.org=

** Container volume preparation
Prepares host directories and users for containers *before* they are created:

- One system user per container
- Predictable volume layout
- Explicit ownership and permissions
- Safe cleanup

See:
- =README-container-vols.org=

** Docker public firewall rules
Manages public exposure of container ports:

- Containers are LAN-only by default
- Public access requires an explicit rule
- Rules persist across reboot
- Easy to list and remove

* Intended Workflow

A typical workflow looks like this:

1. Run the server bootstrap script on a fresh machine
2. Verify LAN access to Cockpit and Portainer
3. Prepare container volumes using =container-vols.sh=
4. Create containers in Portainer
5. If (and only if) needed, expose container ports using the firewall scripts

Each step is intentionally separate.

* Firewall Model (Summary)

- *firewalld zones*:
  - Protect host services
  - Managed via Cockpit
- *DOCKER-USER (iptables)*:
  - Enforces LAN-only policy for containers
  - Acts as the final gate for container traffic

These layers serve different purposes and are not interchangeable.

